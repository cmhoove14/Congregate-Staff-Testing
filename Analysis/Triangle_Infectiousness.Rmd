---
title: "Staff testing model/preventing introductions to congregate facilities/settings"
author: "Chris Hoover et al"
date: "4/5/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(triangle)
library(tidyverse)
library(patchwork)

source(here::here("R/Utils.R"))
```

See [google doc](https://docs.google.com/document/d/1rBGXcljzWvMaS2X9_cOvQFejiESnM3zHGR0H7vRBQ8c/edit) for additional background/ideas/outlining  

## Model framework and parameterization for SARS-CoV2  
Building on previous work investigating the effects of non-pharmaceutical interventions [1](https://doi.org/10.1073/pnas.1616438114) and testing [2](https://doi.org/10.1126/sciadv.abd5393) on the transmission of infectious diseases, we model individual contributions to infection through time from an infectiousness profile generated from key biological parameters of the disease that determine the distribution of infectiousness, $\beta_t$, over the course of the infection. The importance of asymptomatic and presymptomatic transmission of SARS-CoV2 has been widely documented [CITE](https://wwwnc.cdc.gov/eid/article/27/4/20-4576_article), [CITE](https://science.sciencemag.org/content/368/6490/489). In terms of the infectiousness profile for SARS-CoV2, this means that $t_{peak}$ tends to coincide with the onset of symptoms, but occurs after completion of the latent period (i.e. $t_{peak}\approx t_{incubation}$>$t_{latent}$). 

We capture these dynamics using a triangle distribution with infectiousness beginning after the latent period, ending after the duration of the infectious period, and peaking at some point in between ($a=t_{latent}$, $b=t_{tot}=t_{infectious}+t_{latent}$, $c=t_{peak}$, and a<c<b). The expected number of new cases generated at time $t$ is thus $r_{t}=\mathcal{R}\beta_{t}$, where $\mathcal{R}$ is the effective reproduction number interpreted as the expected number of cases generated by a new case over the duration of the infectious period. The model therefore assumes that new cases are most likely to be generated around the time of peak infectiousness, $t_{peak}$. Table X lists the distributions of $t_{incubation}$, $t_{latent}$, and $t_{infectious}$ used here.

In the presence of interventions that isolate infectious individuals prior to $t_{tot}$, e.g. through contact tracing, self-isolation following the onset of symptoms, or asymptomatic testing, the effect of isolation on $\mathcal{R}$ can be directly estimated from the time to isolation as $\mathcal{R}_{iso}=\mathcal{R}\big(1-\int_{t_{iso}}^{t_{tot}}\beta_tdt\big)$, where $t_{iso}$ is the time at which isolation occurs. Reducing $\mathcal{R}$ via improved contact tracing or more frequent testing can thus be envisioned as removing a larger slice from the overall infectiousness triangle by reducing $t_{iso}$. The size of the slice removed is dependent on the shape of the overall triangle distribution, which is determined by $t_{tot}$ and $t_{peak}$, and the location of $t_{iso}$ in relation to $t_{peak}$. For instance, if $t_{iso}>t_{peak}$, then the proportional reduction in $\mathcal{R}$ can be estimated as $\frac{2}{t_{infectious}(t_{tot}-t_{peak})}\int_{t_{iso}}^{t_{tot}}(t_{tot}-t)dt$. Other interventions that reduce $\mathcal{R}$ across all levels of infectiousness such as wearing a mask or reducing the contact rate between infectious and susceptible individuals can also be accommodated simply by multiplying $\mathcal{R}$ by a constant.

```{r include = FALSE, eval = FALSE}
# Text to add re: if t_iso is less than t_peak: more complicated integral

, whereas if $t_{iso}<t_{peak}$, reduction in $R$ is: $\frac{2(t_{tot}-t_{iso})}{t_{infectious}(t_{tot}-t_{peak})}+\frac{2}{t_{infectious}}+\frac{2(t_{iso})}{t_{infectious}(t_{peak}-t_{latent})}$
```


```{r tri_examp, echo = FALSE}
# Triangle schematic -----------------
base_R   <- 1
t_latent <- 3.5
t_peak   <- 5
t_infect <- 8.5
t_tot    <- t_latent + (t_peak-t_latent) + t_infect
dt       <- 0.1

tri <- infectious_profile(t_latent, t_peak, t_infect, dt)

tri_R <- tri*base_R

t_iso <- t_peak + 2

d_iso <- dtriangle(x = t_iso, 
                   a = t_latent,
                   b = t_tot,
                   c = t_peak)

base_R_iso <- base_R * (1-d_iso*(t_tot-t_iso)/2) # reduction equal to 1 minus area of triangle removed 

# Plot with infectiousness removed
tri_examp_plot <- tibble(
  d_inf = seq(0, t_tot, by = dt),
  Rt    = tri_R
  ) %>% 
  ggplot() +
  geom_line(aes(x = d_inf, y = Rt)) + 
  geom_polygon(
    data    = tibble(x = c(t_iso, t_iso,        t_tot),
                     y = c(0    , d_iso*base_R, 0)),
    mapping = aes(x = x, y = y),
    fill    = "grey50",
    col     = "red"
    ) +
  scale_x_continuous(breaks = seq(0,14,2)) +
  theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
  labs(x   = "Days since infection",
       y   = expression(beta[t]),
       tag = "A")

# R_iso as function of t_iso -----------------
t_isos <- seq(3,14,0.1)
R_isos <- sapply(t_isos, function(t){
  R_iso(t_latent, t_peak, t_infect, t, base_R)
})
 
r_iso_t_iso_plot <- tibble(
  t_isos = t_isos,
  R_isos = sapply(t_isos, function(t){
    R_iso(t_latent, t_peak, t_infect, t, base_R)
  })
) %>% 
  ggplot() +
    geom_line(aes(x = t_isos, y = R_isos)) +
    geom_point(data = tibble(x = t_iso, y = base_R_iso),
               aes(x = x, y = y),
               col = "red", size = 2) +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
          axis.title = element_text(size = 13)) +
    scale_x_continuous(breaks = seq(1,15,by=2)) +
    labs(x = expression(t[iso]),
         y = expression(R[iso]),
         tag = "B")
```

```{r save_triangle, include = FALSE, echo = FALSE}
tri_examp_plot

ggsave(here::here("Plots/triangle_example.png"),
       width = 6, height = 3, units = "in")

tri_examp_plot2 <- tibble(
  d_inf = seq(0, t_tot, by = dt),
  Rt    = tri_R
  ) %>% 
  ggplot() +
  geom_line(aes(x = d_inf, y = Rt)) + 
  scale_x_continuous(breaks = seq(0,14,2)) +
  theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
  labs(x   = "Days since infection",
       y   = expression(beta[t]),
       tag = "A")

ggsave(here::here("Plots/triangle_example_no_iso.png"),
       width = 6, height = 3, units = "in")

```

## Analytic results: influence of testing frequency on $t_{iso}$ and $\mathcal{R}_{iso}$  
Assuming testing is independent of symptoms, known contacts, and other reasons for explicitly seeking testing, we can estimate the probability of going $t$ days without being tested from the testing frequency, $f$, as $(1-f)^t$ and the probability that $t_{iso}\leq\tau$ as $\mathrm{P}(t_{iso}=\tau|f)=1-(1-f)^\tau$. 

```{r p_tiso, echo = FALSE, fig.width=6, fig.height=4, fig.cap="Probability of going $t$ days without being tested given constant testing frequencies"}
test_freqs <- 1/c(1,3,5,7,10,14)

fd_grid <- as.data.frame(expand.grid("freqs" = test_freqs, 
                                     "days"  = c(1:14)))
fd_grid$p_t_iso = apply(fd_grid,1,function(x){
  1-(1-x[1])^x[2]
})

p_iso_t_freq_plot <- fd_grid %>% 
  ggplot(aes(x = days, y = p_t_iso, col = as.factor(freqs))) +
    geom_line() +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
    scale_color_manual(breaks = test_freqs,
                       values = c("#c57c3c", "#6588cd", "#7fa83c", "#ab62c0", "#5ca576", "#ca5670"),
                       labels = c("1", "3", "5", "7", "10", "14")) +
    scale_x_continuous(breaks = c(1:14)) +
    ylim(c(0,1)) +
    labs(x = "t days",
         y = expression(P(t[iso]<=t)),
         col = "Testing\n Frequency",
         tag = "C")
```

This allows for incorporation of the testing frequency into estimation of $\mathcal{R_{iso}}$ assuming isolation occurs after a test is conducted on an infectious individual, giving:  
$$\mathbb{E}[\mathcal{R}_{iso}|\beta_t,f]=\mathcal{R}\int_{\tau=t_{latent}}^{t_{infectious}}\beta_\tau(1-f)^{\tau} d\tau$$

```{r test_freq_r_red, echo = FALSE}
n_sims <- 100
R_iso_test_freqs <- bind_rows(lapply(test_freqs, function(f){
  # Draw from distributions for key time periods
  t_inc_samps <- rlnorm(n_sims, 1.63,0.5)
  t_lnt_samps <- t_inc_samps + runif(n_sims, -2.5, 0)
  t_inf_samps <- runif(n_sims, 6.5, 9.5)
  
  R_iso_this <- sapply(1:n_sims, function(i){
    R_iso_f(
      t_latent     = t_lnt_samps[i], 
      t_peak       = t_inc_samps[i], 
      t_infectious = t_inf_samps[i], 
      t_freq       = f, 
      dt           = dt, 
      R            = base_R
    )
  })
  
  return(tibble(R_isos = R_iso_this,
                t_freq = f))
}))


exp_R_iso_t_freq_plot <- R_iso_test_freqs %>% 
  ggplot(aes(y = R_isos, x = as.factor(t_freq))) +
    geom_violin(col = "#8176cc", alpha = 0.7) +
    geom_point(col = "#4fbab7", alpha = 0.5, size = 0.3,
               position = position_dodge2(0.5)) +
    stat_summary(fun = "median",# fun.min = quantile(y,probs = 0.25), fun.max = quantile(probs = 0.75),
                 geom = "crossbar",size = 0.2, width = 0.7) +
    scale_x_discrete(labels = rev(1/test_freqs)) +
    ylim(c(0, base_R)) +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
    labs(x = "Testing frequency (days)",
         y = expression(R[iso]),
         tag = "D")
```


```{r mod_schematic_plot, echo = FALSE, fig.width=8, fig.height=6, fig.cap="**Model framework and analytic results.** A) Example infectiousness profile for $\\mathcal{R}=1$, $t_{latent}=3.5$, $t_{peak}=5$, $t_{infectious}=10$, with shaded area demonstrating infectiousness slice removed if $t_{iso}=7$, leading to $\\mathcal{R}_{iso}=0.5$. B) $R_{iso}$ as a function of $t_{iso}$ with same parameters as in A and point indicating scenario depicted in A. C) Relationship between testing frequency and probability isolation occurs by day $t$, i.e. $t_{iso}\\leq t$. D) Distributions of $\\mathbb{E}[\\mathcal{R}_{iso}|\\beta_t,f]$ as a function of testing frequency, $f$, incorporating uncertainty in $t_{latent}$, $t_{peak}$, and $t_{infectious}$, with baseline $\\mathcal{R}=1$"}

# Four panels with patchwork
(tri_examp_plot | r_iso_t_iso_plot) / (p_iso_t_freq_plot | exp_R_iso_t_freq_plot)

ggsave(here::here("Plots/Framework_Analysis.png"),
       units = "in", height = 6, width = 7)
```

