---
title: "Optimizing COVID-19 screening for shift-workers to reduce introduction of disease from the community"
subtitle: "Methods and results"
author: "Chris Hoover et al"
date: "5/20/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo    = FALSE,
                      include = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(tidyverse)
library(patchwork)
source(here::here("R/Utils.R"))
source(here::here("R/Sim_Functions.R"))

```

## To-dos  
* Add non-compliance with testing regimen 
* Make self-isolation a scenario  
  - Grid of self-isolation to testing compliance?  
* Format for analytic results, followed by grid search of scenarios, followed by sensitivity analyses of optimal scenario subjected to: non-compliance, leaky cohort  

## Model framework and parameterization for SARS-CoV2  
Building on previous work investigating the effects of non-pharmaceutical interventions [ [1](https://doi.org/10.1073/pnas.1616438114) ] and testing [ [2](https://doi.org/10.1126/sciadv.abd5393) ] on the transmission of infectious diseases, we model individual contributions to infection through time from an infectiousness profile, $\beta_t$, generated from key biological parameters of the disease that determine the distribution of infectiousness over time. We model $\beta_t$ using a triangle distribution with infectiousness beginning after the latent period, ending after the duration of the infectious period, and peaking at some point in between ($a=t_{latent}$, $b=t_{tot}=t_{infectious}+t_{latent}$, $c=t_{peak}$, and a<c<b). 

The viral dynamics of SARS-CoV2 make control efforts challenging, as asymptomatic and presymptomatic transmission caused by high infectiousness in the absence of symptoms are common [CITE](https://wwwnc.cdc.gov/eid/article/27/4/20-4576_article), [CITE](https://science.sciencemag.org/content/368/6490/489). In terms of the infectiousness profile for SARS-CoV2, this means that peak infectiousness $t_{peak}$ tends to coincide with the onset of symptoms (for cases that are symptomatic), but occurs after completion of the latent period (i.e. $t_{peak}\approx t_{incubation}$>$t_{latent}$). The expected number of new cases generated at time $t$ is thus $r_{t}=\mathcal{R}\beta_{t}$, where $\mathcal{R}$ is the effective reproduction number interpreted as the expected number of cases generated by a new case over the duration of the infectious period. The model therefore assumes that new cases are most likely to be generated around the time of peak infectiousness, $t_{peak}$. Table X lists the distributions of $t_{incubation}$, $t_{latent}$, and $t_{infectious}$ used here.

In the presence of interventions that isolate infectious individuals prior to $t_{tot}$, e.g. through contact tracing, self-isolation following the onset of symptoms, or testing, the effect of isolation on $\mathcal{R}$ can be directly estimated from the time to isolation as $\mathcal{R}_{iso}=\mathcal{R}\big(1-\int_{t_{iso}}^{t_{tot}}\beta_tdt\big)$, where $t_{iso}$ is the time at which isolation occurs. Reducing $\mathcal{R}_{iso}$ via improved contact tracing or more frequent testing can thus be envisioned as removing a larger slice from the overall infectiousness triangle by reducing $t_{iso}$. The size of the slice removed is dependent on the shape of the overall triangle distribution, which is primarily determined by $t_{tot}$ and $t_{peak}$, and the location of $t_{iso}$ in relation to $t_{peak}$. For instance, if $t_{iso}>t_{peak}$, then the proportional reduction in $\mathcal{R}$ can be estimated as $\frac{2}{t_{infectious}(t_{tot}-t_{peak})}\int_{t_{iso}}^{t_{tot}}(t_{tot}-t)dt$. Other interventions that reduce $\mathcal{R}$ across all levels of infectiousness such as wearing a mask or reducing the contact rate between infectious and susceptible individuals can also be accommodated simply by multiplying $\mathcal{R}$ by a constant.

```{r include = FALSE, eval = FALSE}
# Text to add re: if t_iso is less than t_peak: more complicated integral

, whereas if $t_{iso}<t_{peak}$, reduction in $R$ is: $\frac{2(t_{tot}-t_{iso})}{t_{infectious}(t_{tot}-t_{peak})}+\frac{2}{t_{infectious}}+\frac{2(t_{iso})}{t_{infectious}(t_{peak}-t_{latent})}$
```


```{r tri_examp, echo = FALSE}
# Triangle schematic -----------------
base_R   <- 1
t_latent <- 3.5
t_peak   <- 5
t_infect <- 8.5
t_tot    <- t_latent + (t_peak-t_latent) + t_infect
dt       <- 0.1

tri <- infectious_profile(t_latent, t_peak, t_infect, dt)

tri_R <- tri*base_R

t_iso <- t_peak + 2

d_iso <- dtriangle(x = t_iso, 
                   a = t_latent,
                   b = t_tot,
                   c = t_peak)

base_R_iso <- base_R * (1-d_iso*(t_tot-t_iso)/2) # reduction equal to 1 minus area of triangle removed 

# Plot with infectiousness removed
tri_examp_plot <- tibble(
  d_inf = seq(0, t_tot, by = dt),
  Rt    = tri_R
  ) %>% 
  ggplot() +
  geom_line(aes(x = d_inf, y = Rt)) + 
  geom_polygon(
    data    = tibble(x = c(t_iso, t_iso,        t_tot),
                     y = c(0    , d_iso*base_R, 0)),
    mapping = aes(x = x, y = y),
    fill    = "grey50",
    col     = "red"
    ) +
  scale_x_continuous(breaks = seq(0,14,2)) +
  theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
  labs(x   = "Days since infection",
       y   = expression(beta[t]),
       tag = "A")

# R_iso as function of t_iso -----------------
t_isos <- seq(3,14,0.1)
R_isos <- sapply(t_isos, function(t){
  R_iso(t_latent, t_peak, t_infect, t, base_R)
})
 
r_iso_t_iso_plot <- tibble(
  t_isos = t_isos,
  R_isos = sapply(t_isos, function(t){
    R_iso(t_latent, t_peak, t_infect, t, base_R)
  })
) %>% 
  ggplot() +
    geom_line(aes(x = t_isos, y = R_isos)) +
    geom_point(data = tibble(x = t_iso, y = base_R_iso),
               aes(x = x, y = y),
               col = "red", size = 2) +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
          axis.title = element_text(size = 13)) +
    scale_x_continuous(breaks = seq(1,15,by=2)) +
    labs(x = expression(t[iso]),
         y = expression(R[iso]),
         tag = "B")
```

```{r save_triangle, include = FALSE, echo = FALSE}
tri_examp_plot

ggsave(here::here("Plots/triangle_example.png"),
       width = 6, height = 3, units = "in")

tri_examp_plot2 <- tibble(
  d_inf = seq(0, t_tot, by = dt),
  Rt    = tri_R
  ) %>% 
  ggplot() +
  geom_line(aes(x = d_inf, y = Rt)) + 
  scale_x_continuous(breaks = seq(0,14,2)) +
  theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
  labs(x   = "Days since infection",
       y   = expression(beta[t]),
       tag = "A")

ggsave(here::here("Plots/triangle_example_no_iso.png"),
       width = 6, height = 3, units = "in")

```

Assuming testing is independent of symptoms, known contacts, and other reasons for explicitly seeking testing, we can estimate the probability of going $t$ days without being tested from the testing frequency, $f$, as $(1-f)^t$ and the probability that $t_{iso}\leq\tau$ as $\mathrm{P}(t_{iso}=\tau|f)=1-(1-f)^\tau$, assuming isolation occurs immediately after testing. Given substantial turnaround times between testing and isolation, particularly when relying on PCR-based tests, we can also incorporate the delay between testing and isolation, $d$, as: $\mathrm{P}(t_{iso}=\tau|f,d)=1-\Big(1-\frac{1}{f^{-1}+d}\Big)^\tau$, where $f^{-1}$ is simply the average number of days between tests.

This allows for incorporation of the testing frequency and delay into estimation of $\mathcal{R}_{iso}$ :  
$$\mathbb{E}[\mathcal{R}_{iso}|\beta_t,f,d]=\mathcal{R}\int_{\tau=t_{latent}}^{t_{infectious}}\beta_\tau\Big(1-\frac{1}{f^{-1}+d}\Big)^\tau d\tau$$

```{r p_tiso, echo = FALSE, fig.width=6, fig.height=4, fig.cap="Probability of going $t$ days without being tested given constant testing frequencies"}
test_freqs <- 1/c(1,3,5,7,10,14)

fd_grid <- as.data.frame(expand.grid("freqs" = test_freqs, 
                                     "days"  = c(1:14),
                                     "delay" = c(0:2)))

fd_grid$p_t_iso = apply(fd_grid,1,function(x){
  1-(1-1/(x[1]^-1+x[3]))^x[2]
})

d_labs <- paste0("d = ", c(0:2))
names(d_labs) <- c(0:2)

p_iso_t_freq_plot <- fd_grid %>% 
  ggplot(aes(x = days, y = p_t_iso, col = as.factor(freqs))) +
    geom_line() +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
          axis.title = element_text(size = 13),
          strip.background = element_blank(),
          strip.text = element_text(face = "italic",
                                    size = 11)) +
    scale_color_manual(breaks = test_freqs,
                       values = c("#c57c3c", "#6588cd", "#7fa83c", "#ab62c0", "#5ca576", "#ca5670"),
                       labels = c("1", "3", "5", "7", "10", "14")) +
    scale_x_continuous(breaks = c(1,3,5,7,9,11,13)) +
    facet_wrap("delay", nrow = 3,
               labeller = labeller(delay = d_labs)) +
    ylim(c(0,1)) +
    labs(x = "t days",
         y = expression(P(t[iso]<=t)),
         col = "Testing\n Frequency",
         tag = "D")
```

```{r test_freq_r_red_par_uncertainty_distn, echo = FALSE}
n_sims <- 100
R_iso_test_freqs <- bind_rows(lapply(test_freqs, function(f){
  # Draw from distributions for key time periods
  inf_pars <- sim_inf_pars(n_sims)
  
  t_inc_samps <- inf_pars[,1]
  t_lnt_samps <- inf_pars[,2]
  t_inf_samps <- inf_pars[,3]
  
  R_iso_d0 <- sapply(1:n_sims, function(i){
    R_iso_f(
      t_latent     = t_lnt_samps[i], 
      t_peak       = t_inc_samps[i], 
      t_infectious = t_inf_samps[i], 
      t_freq       = f, 
      dt           = dt, 
      d            = 0,
      R            = base_R
    )
  })
  
  R_iso_d1 <- sapply(1:n_sims, function(i){
    R_iso_f(
      t_latent     = t_lnt_samps[i], 
      t_peak       = t_inc_samps[i], 
      t_infectious = t_inf_samps[i], 
      t_freq       = f, 
      dt           = dt, 
      d            = 1,
      R            = base_R
    )
  })

  R_iso_d2 <- sapply(1:n_sims, function(i){
    R_iso_f(
      t_latent     = t_lnt_samps[i], 
      t_peak       = t_inc_samps[i], 
      t_infectious = t_inf_samps[i], 
      t_freq       = f, 
      dt           = dt, 
      d            = 2,
      R            = base_R
    )
  })
    
  return(tibble(R_isos = c(R_iso_d0, R_iso_d1, R_iso_d2),
                delay  = c(rep(0, n_sims), rep(1, n_sims), rep(2, n_sims)),
                t_freq = f))
}))

exp_R_iso_t_freq_plot <- R_iso_test_freqs %>% 
  ggplot(aes(y = R_isos, x = as.factor(t_freq), col = as.factor(delay))) +
    geom_boxplot() +
    #geom_point(alpha = 0.5, size = 0.3, position = position_dodge2(0.5)) +
    # stat_summary(fun = "median", #fun.min = "q_25", fun.max = "q_75",
    #              position = position_dodge2(1),
    #              size = 0.2) +
    scale_x_discrete(labels = rev(1/test_freqs)) +
    scale_color_manual(values = c("#ff7eca", "#00b7fe", "#4e4b8b")) +
    ylim(c(0, base_R)) +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
    labs(x = "Testing frequency (days)",
         y = expression(R[iso]),
         col = expression(italic(d)),
         tag = "C")
```


```{r test_freq_r_red, eval = FALSE}
R_iso_d0s <- sapply(test_freqs, function(f){
    R_iso_f(
      t_latent     = t_latent, 
      t_peak       = t_peak, 
      t_infectious = t_infect, 
      t_freq       = f, 
      dt           = dt, 
      d            = 0,
      R            = base_R
    )
  })

R_iso_d1s <- sapply(test_freqs, function(f){
    R_iso_f(
      t_latent     = t_latent, 
      t_peak       = t_peak, 
      t_infectious = t_infect, 
      t_freq       = f, 
      dt           = dt, 
      d            = 1,
      R            = base_R
    )
  })

R_iso_d2s <- sapply(test_freqs, function(f){
    R_iso_f(
      t_latent     = t_latent, 
      t_peak       = t_peak, 
      t_infectious = t_infect, 
      t_freq       = f, 
      dt           = dt, 
      d            = 2,
      R            = base_R
    )
  })

R_iso_test_freqs <- tibble(R_isos = c(R_iso_d0s, R_iso_d1s, R_iso_d2s),
                           delay  = c(rep(0, length(test_freqs)), 
                                      rep(1, length(test_freqs)), 
                                      rep(2, length(test_freqs))),
                           t_freq = rep(test_freqs, times = 3))

exp_R_iso_t_freq_plot <- R_iso_test_freqs %>% 
  ggplot(aes(y = R_isos, x = as.factor(t_freq), col = as.factor(delay))) +
    geom_violin(alpha = 0.7) +
    #geom_point(alpha = 0.5, size = 0.3, position = position_dodge2(0.5)) +
    stat_summary(fun = "median", #fun.min = "q_25", fun.max = "q_75",
                 position = position_dodge2(1),
                 size = 0.2) +
    scale_x_discrete(labels = rev(1/test_freqs)) +
    ylim(c(0, base_R)) +
    theme_classic() +
    theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 13)) +
    labs(x = "Testing frequency (days)",
         y = expression(R[iso]),
         col = expression(italic(d)),
         tag = "C")
```


```{r mod_schematic_plot, echo = FALSE, include = TRUE, fig.width=8, fig.height=6, fig.cap="**Model framework and analytic results.** A) Example infectiousness profile for $\\mathcal{R}=1$, $t_{latent}=3.5$, $t_{peak}=5$, $t_{infectious}=10$, with shaded area demonstrating infectiousness slice removed if $t_{iso}=7$, leading to $\\mathcal{R}_{iso}=0.5$. B) $\\mathcal{R}_{iso}$ as a function of $t_{iso}$ with same parameters as in A and point indicating scenario depicted in A. C)  Boxplots showing distributions of $\\mathbb{E}[\\mathcal{R}_{iso}|\\beta_t,f,d]$ as a function of testing frequency, $f$, and test delay, $d$, incorporating uncertainty in $t_{latent}$, $t_{peak}$, and $t_{infectious}$ by drawing $n=100$ parameter sets for each, with baseline $\\mathcal{R}=1$. Boxplots indicate median, interquartile range, and full range of values of $\\mathbb{E}[\\mathcal{R}_{iso}|\\beta_t,f,d]$. D) Relationship between testing frequency, $f$, test delay, $d$, and probability isolation occurs by day $t$, i.e. $t_{iso}\\leq t$, demonstrating that delays in testing substantially reduce the probability of prompt isolation, particularly in more frequent testing scenarios."}

# Four panels with patchwork
(tri_examp_plot / r_iso_t_iso_plot / exp_R_iso_t_freq_plot) | p_iso_t_freq_plot 

ggsave(here::here("Plots/Framework_Analysis.png"),
       units = "in", height = 6, width = 7)
```

## Individual-based model simulations   
* All staff are assigned a work schedule that determines time frames when they are working. $\mathbf{I}(w_{it})$ is an indicator function for whether staff member $i$ is working at the facility on day $t$.  
* In addition to their work schedule, all staff are assigned a testing schedule, encoded by function $\mathbf{T}(w_{it})$.  
* All staff are subject to two sources of infection: community and workplace, represented by force of infection parameters $\lambda_c$ and $\lambda_w$, respectively. In addition, we introduce a partitioning parameter, $\alpha$, representing the relative probability of acquiring infection in the workplace versus in the community, therefore $\lambda_w=\lambda_c\alpha$ and $\Lambda_{it}=\lambda_c\alpha\mathbf{I}(w_{it})+\lambda_c(1-\mathbf{I}(w_{it}))$. New cases at each time step are then generated by subjecting all susceptible staff to a Bernoulli trial where $p=\Lambda_{it}$  
* Whenever a new staff infection is generated, parameters for the individual are drawn to determine the latent period ($t_{latent}$), the incubation period ($t_{incubation}$), and the total infectious period ($t_{infectious}$) to generate an infectiousness profile ($\beta_{it}$). Assuming constant $\mathcal{R}$ across all individuals, the expected number of workplace cases produced on day $t$ by individual $i$ is $r_{it}=\mathcal{R}\beta_{it}\mathbf{I}(w_{it})$  
* Main outcome is expected number of cases transmitted by staff over the simulation timeframe: $\mathbf{E}[cases]=\sum_{t=1}^{t_{sim}}\sum_{i=1}^n\mathbf{I}(w_{it})r_{it}$   
* Isolated staff are not retested, but recovered staff are tested as normal  

### "Grid search" Over frequency, delay, and systematic vs random testing  
Basically interested in three variables: pcr vs antigen testing (which basically comes down to turnaround time if we assume antigen tests are equal to pcr in their ability to detect active infection), random vs systematic day of testing, and frequency of testing. We propose the following scenarios encompassing combinations of these variables to explore:

* **S1)** No testing  
* **S2)** Random PCR testing once per work week with test report on second day following test  
* **S3)** Random antigen testing once per work week with immediate test report  
* **S4)** PCR testing on first day of work week with test report on second day following test  
* **S5)** Antigen testing on first day of work week with immediate test report  
* **S6)** Random PCR testing twice per work week with test report on second day following test  
* **S7)** Random antigen testing twice per work week with immediate test report  
* **S8)** PCR testing on first and third day of work week with test report on second day following test  
* **S9)** Antigen testing on first and third day of work week with immediate test report  
* **S10)** PCR testing on all days of work week with test report on second day following test  
* **S11)** Antigen testing on all days of work week with immediate test report  

```{r sim_setup, echo = FALSE}
# Sim inputs
  n_sims      <- 100
  lambda1     <- 0.3/100
  lambda2     <- 1/100
  lambda3     <- 3/100
  days        <- 180
  dt          <- 8/24
  sim_t       <- days*(1/dt)
  n_staff     <- 700
  staff_state <- rep("S", n_staff)

# Generate master schedule
  work_weeks         <- ceiling(days/7)
  schedule_shifts    <- rep(c("M", "E", "N"), times = days)
  schedule_days      <- rep(rep(c("U", "M", "T", "W", "R", "F", "S"), each = 1/dt), 
                         times = work_weeks)[1:length(schedule_shifts)]
  schedule_work_week <- rep(1:work_weeks, each = 7/dt)[1:length(schedule_shifts)]
  master_schedule    <- paste(schedule_days, schedule_shifts, schedule_work_week, sep = "_")

```

```{r base_workers, echo = FALSE}
set.seed(430)
# Generate list of workers with no testing for model simulation
workers <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"
  
  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule  
  test_schedule <- rep(0, sim_t)
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})
```

```{r workers_testdays, echo = FALSE}
set.seed(430)
# Generate list of workers with systematic testing 
# on first day of shift
workers_testday1 <- generate_workers(n_workers       = n_staff,
                                     sim_t           = sim_t,
                                     schedule_days   = schedule_days,
                                     schedule_shifts = schedule_shifts,
                                     testdays        = 1)

# on first day of shift every other week
workers_testday1_biweekly <- generate_workers(n_workers       = n_staff,
                                              sim_t           = sim_t,
                                              schedule_days   = schedule_days,
                                              schedule_shifts = schedule_shifts,
                                              testdays        = 1,
                                              biweekly        = TRUE)

# on second day of shift
workers_testday2 <- generate_workers(n_workers       = n_staff,
                                     sim_t           = sim_t,
                                     schedule_days   = schedule_days,
                                     schedule_shifts = schedule_shifts,
                                     testdays        = 2)

# on third day of shift
workers_testday3 <- generate_workers(n_workers       = n_staff,
                                     sim_t           = sim_t,
                                     schedule_days   = schedule_days,
                                     schedule_shifts = schedule_shifts,
                                     testdays        = 3)

# on fourth day of shift
workers_testday4 <- generate_workers(n_workers       = n_staff,
                                     sim_t           = sim_t,
                                     schedule_days   = schedule_days,
                                     schedule_shifts = schedule_shifts,
                                     testdays        = 4)

# on first and third day of shift
workers_testday13 <- generate_workers(n_workers       = n_staff,
                                      sim_t           = sim_t,
                                      schedule_days   = schedule_days,
                                      schedule_shifts = schedule_shifts,
                                      testdays        = c(1,3))

# on second and fourth day of shift
workers_testday24 <- generate_workers(n_workers       = n_staff,
                                      sim_t           = sim_t,
                                      schedule_days   = schedule_days,
                                      schedule_shifts = schedule_shifts,
                                      testdays        = c(2,4))

# on all but last day of shift
workers_testday1234 <- generate_workers(n_workers       = n_staff,
                                        sim_t           = sim_t,
                                        schedule_days   = schedule_days,
                                        schedule_shifts = schedule_shifts,
                                        testdays        = c(1:4))
# Random work days
# Single random day during the work week
workers_testday_r1 <- generate_workers_random(n_workers        = n_staff,
                                              sim_t            = sim_t,
                                              schedule_days    = schedule_days,
                                              schedule_shifts  = schedule_shifts,
                                              master_schedule  = master_schedule,
                                              n_tests_per_week = 1)

# Single random every other week
workers_testday_r1_biweekly <- generate_workers_random(n_workers        = n_staff,
                                                     sim_t            = sim_t,
                                                     schedule_days    = schedule_days,
                                                     schedule_shifts  = schedule_shifts,
                                                     master_schedule  = master_schedule,
                                                     n_tests_per_week = 1,
                                                     biweekly        = TRUE)

# Two random days during the work week
workers_testday_r2 <- generate_workers_random(n_workers        = n_staff,
                                              sim_t            = sim_t,
                                              schedule_days    = schedule_days,
                                              schedule_shifts  = schedule_shifts,
                                              master_schedule  = master_schedule,
                                              n_tests_per_week = 2)

# Four random days during the work week
workers_testday_r4 <- generate_workers_random(n_workers        = n_staff,
                                              sim_t            = sim_t,
                                              schedule_days    = schedule_days,
                                              schedule_shifts  = schedule_shifts,
                                              master_schedule  = master_schedule,
                                              n_tests_per_week = 4)

```

```{r test_runs, echo=FALSE, eval = FALSE}
no_tests <- sim_work_transmission(Lambda    = 0.01*dt,
                                  alpha     = 0,
                                  R         = 1,
                                  delay     = 0,
                                  test_sens = 0,
                                  workers   = workers,
                                  sim_t     = sim_t,
                                  dt        = dt,
                                  verbose   = F)

all_tests <-   sim_work_transmission(Lambda = 0.01*dt,
                                     alpha   = 0,
                                     R       = 1,
                                     delay   = 0,
                                     test_sens = 0,
                                     workers = workers_testday1234,
                                     sim_t   = sim_t,
                                     dt      = dt,
                                     verbose = F)

table(unlist(lapply(all_tests$workers, function(w) w$state[sim_t])))
```


```{r run_sims_R_work0_lambda1, echo = FALSE, cache = TRUE}
# No testing  
no_test_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda    = lambda1*dt,
                        R_work     = 0,
                        R         = 1,
                        delay     = 0,
                        test_sens = 0,
                        workers   = workers,
                        sim_t     = sim_t,
                        dt        = dt,
                        verbose   = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S1",
           R_work = 0,
           delay = 0,
           testday = "None",
           lambda = lambda1, 
           testfreq = 0)
}))

# Random pcr testing once every other week
test_r1_biweek_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S12",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# Random antigen testing once every other week
test_r1_biweek_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S13",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))


# Random pcr testing once per week
test_r1_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S2",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# Random antigen testing once per week
test_r1_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S3",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# pcr testing on the first workday of every other week
test_day1_biweek_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S14",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 0.5)
}))

# antigen testing on the first workday of every other week
test_day1_biweek_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S15",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 0.5)
}))


# pcr testing on first day of work week
test_day1_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S4",
           R_work = 0,
           delay = 2,
           testday = "1",
           lambda = lambda1, 
           testfreq = 1)
}))


# antigen testing on first day of work week
test_day1_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S5",
           R_work = 0,
           delay = 0,
           testday = "1",
           lambda = lambda1, 
           testfreq = 1)
}))


# Random pcr testing twice per week
test_r2_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S6",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 2)
}))


# Random antigen testing twice per week
test_r2_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S7",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 2)
}))


# pcr testing on first and third day of work week
test_day13_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S8",
           R_work = 0,
           delay = 2,
           testday = "13",
           lambda = lambda1, 
           testfreq = 2)
}))


# antigen testing on first and third day of work week
test_day13_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S9",
           R_work = 0,
           delay = 0,
           testday = "13",
           lambda = lambda1, 
           testfreq = 2)
}))

# pcr testing on all but last day of work week
test_day1234_pcr_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S10",
           R_work = 0,
           delay = 2,
           testday = "1234",
           lambda = lambda1, 
           testfreq = 4)
}))


# antigen testing on all but last day
test_day1234_ant_sims_l1_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S11",
           R_work = 0,
           delay = 0,
           testday = "1234",
           lambda = lambda1, 
           testfreq = 4)
}))
```

```{r run_sims_R_work0_lambda2, echo = FALSE, cache = TRUE}
# No testing  
no_test_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda    = lambda2*dt,
                        R_work     = 0,
                        R         = 1,
                        delay     = 0,
                        test_sens = 0,
                        workers   = workers,
                        sim_t     = sim_t,
                        dt        = dt,
                        verbose   = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S1",
           R_work = 0,
           delay = 0,
           testday = "None",
           lambda = lambda2, 
           testfreq = 0)
}))

# Random pcr testing once every other week
test_r1_biweek_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S12",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 0.5)
}))

# Random antigen testing once every other week
test_r1_biweek_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S13",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 0.5)
}))

# Random pcr testing once per week
test_r1_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S2",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 1)
}))

# pcr testing on the first workday of every other week
test_day1_biweek_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S14",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 0.5)
}))

# antigen testing on the first workday of every other week
test_day1_biweek_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S15",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 0.5)
}))

# Random antigen testing once per week
test_r1_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S3",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 1)
}))

# pcr testing on first day of work week
test_day1_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S4",
           R_work = 0,
           delay = 2,
           testday = "1",
           lambda = lambda2, 
           testfreq = 1)
}))


# antigen testing on first day of work week
test_day1_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S5",
           R_work = 0,
           delay = 0,
           testday = "1",
           lambda = lambda2, 
           testfreq = 1)
}))


# Random pcr testing twice per week
test_r2_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S6",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 2)
}))


# Random antigen testing twice per week
test_r2_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S7",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda2, 
           testfreq = 2)
}))


# pcr testing on first and third day of work week
test_day13_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S8",
           R_work = 0,
           delay = 2,
           testday = "13",
           lambda = lambda2, 
           testfreq = 2)
}))


# antigen testing on first and third day of work week
test_day13_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S9",
           R_work = 0,
           delay = 0,
           testday = "13",
           lambda = lambda2, 
           testfreq = 2)
}))

# pcr testing on all but last day
test_day1234_pcr_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S10",
           R_work = 0,
           delay = 2,
           testday = "1234",
           lambda = lambda2, 
           testfreq = 4)
}))


# antigen testing on all but last day
test_day1234_ant_sims_l2_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda2*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S11",
           R_work = 0,
           delay = 0,
           testday = "1234",
           lambda = lambda2, 
           testfreq = 4)
}))
```

```{r run_sims_R_work0_lambda3, echo = FALSE, cache = TRUE}
# No testing  
no_test_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda    = lambda3*dt,
                        R_work     = 0,
                        R         = 1,
                        delay     = 0,
                        test_sens = 0,
                        workers   = workers,
                        sim_t     = sim_t,
                        dt        = dt,
                        verbose   = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S1",
           R_work = 0,
           delay = 0,
           testday = "None",
           lambda = lambda3, 
           testfreq = 0)
}))

# Random pcr testing once every other week
test_r1_biweek_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S12",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 0.5)
}))

# Random antigen testing once every other week
test_r1_biweek_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S13",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 0.5)
}))


# Random pcr testing once per week
test_r1_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S2",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 1)
}))


# Random antigen testing once per week
test_r1_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S3",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 1)
}))

# pcr testing on the first workday of every other week
test_day1_biweek_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S14",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 0.5)
}))

# antigen testing on the first workday of every other week
test_day1_biweek_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S15",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 0.5)
}))


# pcr testing on first day of work week
test_day1_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S4",
           R_work = 0,
           delay = 2,
           testday = "1",
           lambda = lambda3, 
           testfreq = 1)
}))


# antigen testing on first day of work week
test_day1_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S5",
           R_work = 0,
           delay = 0,
           testday = "1",
           lambda = lambda3, 
           testfreq = 1)
}))


# Random pcr testing twice per week
test_r2_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S6",
           R_work = 0,
           delay = 2,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 2)
}))


# Random antigen testing twice per week
test_r2_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S7",
           R_work = 0,
           delay = 0,
           testday = "rand",
           lambda = lambda3, 
           testfreq = 2)
}))


# pcr testing on first and third day of work week
test_day13_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S8",
           R_work = 0,
           delay = 2,
           testday = "13",
           lambda = lambda3, 
           testfreq = 2)
}))


# antigen testing on first and third day of work week
test_day13_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S9",
           R_work = 0,
           delay = 0,
           testday = "13",
           lambda = lambda3, 
           testfreq = 2)
}))

# pcr testing on first and third day of work week
test_day1234_pcr_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S10",
           R_work = 0,
           delay = 2,
           testday = "1234",
           lambda = lambda3, 
           testfreq = 4)
}))


# antigen testing on all but last day
test_day1234_ant_sims_l3_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda3*dt,
                        R_work   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S11",
           R_work = 0,
           delay = 0,
           testday = "1234",
           lambda = lambda3, 
           testfreq = 4)
}))
```

```{r sum_sims, echo = FALSE, message = FALSE}
#qwraps2::lazyload_cache_dir("Analysis/Methods_Results_cache/docx/")

# Data frame summarizing each simulation's status at the end: tests and expected cases 
sims_end <- bind_rows(
  no_test_sims_l1_a0,
  test_r1_biweek_pcr_sims_l1_a0,
  test_r1_biweek_ant_sims_l1_a0,
  test_r1_pcr_sims_l1_a0,
  test_r1_ant_sims_l1_a0,
  test_day1_biweek_pcr_sims_l1_a0,
  test_day1_biweek_ant_sims_l1_a0,
  test_day1_pcr_sims_l1_a0,
  test_day1_ant_sims_l1_a0,
  test_r2_pcr_sims_l1_a0,
  test_r2_ant_sims_l1_a0,
  test_day13_pcr_sims_l1_a0,
  test_day13_ant_sims_l1_a0,
  test_day1234_pcr_sims_l1_a0,
  test_day1234_ant_sims_l1_a0,
  no_test_sims_l2_a0,
  test_r1_biweek_pcr_sims_l2_a0,
  test_r1_biweek_ant_sims_l2_a0,
  test_r1_pcr_sims_l2_a0,
  test_r1_ant_sims_l2_a0,
  test_day1_biweek_pcr_sims_l2_a0,
  test_day1_biweek_ant_sims_l2_a0,
  test_day1_pcr_sims_l2_a0,
  test_day1_ant_sims_l2_a0,
  test_r2_pcr_sims_l2_a0,
  test_r2_ant_sims_l2_a0,
  test_day13_pcr_sims_l2_a0,
  test_day13_ant_sims_l2_a0,
  test_day1234_pcr_sims_l2_a0,
  test_day1234_ant_sims_l2_a0,
  no_test_sims_l3_a0,
  test_r1_biweek_pcr_sims_l3_a0,
  test_r1_biweek_ant_sims_l3_a0,
  test_r1_pcr_sims_l3_a0,
  test_r1_ant_sims_l3_a0,
  test_day1_biweek_pcr_sims_l3_a0,
  test_day1_biweek_ant_sims_l3_a0,
  test_day1_pcr_sims_l3_a0,
  test_day1_ant_sims_l3_a0,
  test_r2_pcr_sims_l3_a0,
  test_r2_ant_sims_l3_a0,
  test_day13_pcr_sims_l3_a0,
  test_day13_ant_sims_l3_a0,
  test_day1234_pcr_sims_l3_a0,
  test_day1234_ant_sims_l3_a0
) %>% 
  group_by(sim, scenario, delay, testday, lambda, testfreq) %>% 
  summarise(totcases = sum(exp_cases),
            totdays  = sum(inf_days),
            tottests = sum(tests_adm)) %>% 
  ungroup()

# Summarise across all simulations for each parameter set
sims_sum <- sims_end %>% 
  group_by(scenario, delay, testday, lambda, testfreq) %>% 
  summarise(across(.cols = c("totcases", "totdays", "tottests"),
                   .fns  = list("median", "q_025", "q_25", "q_75", "q_975"))) %>% 
  ungroup()

# get expected cases in no-testing scenario for each transmission intensity
a0l1_exp_cases_base <- sims_sum %>% 
  filter(testday == "None" & lambda == lambda1) %>% 
  pull(totcases_1)

a0l2_exp_cases_base <- sims_sum %>% 
  filter(testday == "None" & lambda == lambda2) %>% 
  pull(totcases_1)

a0l3_exp_cases_base <- sims_sum %>% 
  filter(testday == "None" & lambda == lambda3) %>% 
  pull(totcases_1)

# Add cases avoided in reference to no-testing scenario
sims_sum2 <- sims_end %>% 
  mutate(avoidedpertest = case_when(lambda == lambda1 ~ round((a0l1_exp_cases_base-totcases) / tottests * 1000, 2),
                                    lambda == lambda2 ~ round((a0l2_exp_cases_base-totcases) / tottests * 1000, 2),
                                    lambda == lambda3 ~ round((a0l3_exp_cases_base-totcases) / tottests * 1000, 2)),
         tests1000s = tottests/1000) %>% 
  group_by(delay, testday,testfreq,lambda, scenario) %>% 
  summarise(across(.cols = c("totcases", "tests1000s", "avoidedpertest"),
                   .fns  = list("median", "q_25", "q_75"))) %>% 
  ungroup() %>% 
  mutate(`TestScenario` = case_when(scenario == "S1" ~ "None",
                                    scenario == "S2" ~ "Rand1pw PCR",
                                    scenario == "S3" ~ "Random weekly",
                                    scenario == "S4" ~ "Syst1pw PCR",
                                    scenario == "S5" ~ "Systematic weekly",
                                    scenario == "S6" ~ "Rand2pw PCR",
                                    scenario == "S7" ~ "Random 2/week",
                                    scenario == "S8" ~ "Syst2pw PCR",
                                    scenario == "S9" ~ "Systematic 2/week",
                                    scenario == "S10" ~ "Syst4pw PCR",
                                    scenario == "S11" ~ "Systematic 4/week",
                                    scenario == "S12" ~ "Rand05pw PCR",
                                    scenario == "S13" ~ "Random biweekly",
                                    scenario == "S14" ~ "Syst05pw PCR",
                                    scenario == "S15" ~ "Systematic biweekly"))

sims_cases_sum <- sims_sum2 %>% 
  mutate("Expected Cases" = paste0(round(totcases_1), " (", 
                                   round(totcases_2), " - ",
                                   round(totcases_3), ")")) %>% 
  dplyr::select(scenario, lambda, delay, testday, testfreq, totcases_1, `Expected Cases`)

sims_tests_sum <- sims_sum2 %>% 
  mutate("Tests Conducted (1000s)" = paste0(round(tests1000s_1/1000), " (", 
                                            round(tests1000s_2/1000), " - ",
                                            round(tests1000s_3/1000), ")")) %>% 
  dplyr::select(scenario, lambda, tests1000s_1, `Tests Conducted (1000s)`)

sims_avoided_sum <- sims_sum2 %>% 
  mutate("Avoided/1000 tests" = paste0(round(avoidedpertest_1,2), " (", 
                                       round(avoidedpertest_2,2), " - ",
                                       round(avoidedpertest_3,2), ")")) %>% 
  dplyr::select(scenario, lambda, avoidedpertest_1, `Avoided/1000 tests`)


sims_all_sum <- sims_cases_sum %>% 
  left_join(sims_tests_sum, by = c("scenario", "lambda")) %>% 
  left_join(sims_avoided_sum, by = c("scenario", "lambda"))

```

```{r sims_sum_fig, include = TRUE}
sims_sum2 %>% 
  filter(delay == 0) %>% 
  mutate(avoidedpertest_2 = if_else(is.infinite(avoidedpertest_2), NA_real_, avoidedpertest_2),
         avoidedpertest_3 = if_else(is.infinite(avoidedpertest_3), NA_real_, avoidedpertest_3)) %>% 
  pivot_longer(cols = totcases_1:avoidedpertest_3,
               names_sep = "_",
               names_to = c("measure", ".value")) %>% 
  rename("Med" = `1`,
         "q25" = `2`,
         "q75" = `3`) %>% 
  mutate(measure = factor(case_when(measure == "avoidedpertest" ~ "Cases avoided/test",
                                    measure == "tests1000s" ~ "Tests (1000s)",
                                    measure == "totcases" ~ "Cases"), 
         levels = c("Cases", "Tests (1000s)", "Cases avoided/test"))) %>% 
  ggplot(aes(x = as.factor(lambda),
             y = Med,
             ymin = q25,
             ymax = q75,
             fill = TestScenario)) +
    geom_col(position = position_dodge()) +
    geom_errorbar(position =position_dodge(width = 0.9)) +
    facet_wrap(.~measure, scales = "free_y") +
    scale_fill_manual(values = c("#ca5642", "#c65c8a", "#d09744", "#b05cc6",
                                 "#70b249", "#6e7ecb", "#81833a", "#4bae92")) +
    theme_classic() +
    theme(strip.background = element_blank(),
          strip.text = element_text(face = "bold", size = 12)) +
    labs(x = "Community Prevalence", y = "Value")

ggsave(here::here("Plots/sim_results.png"),
       width = 7.5, height = 4, units = "in")
```


```{r sims_sum_table, include = FALSE}
sims_all_sum %>% 
  arrange(-lambda, -totcases_1) %>% 
  dplyr::select(-c(totcases_1, tests1000s_1, avoidedpertest_1)) %>% 
  knitr::kable(caption = "Expected cases imported into facility across different testing scenarios indicated by test frequency, $f$, test delay, $d$, and systematic vs random testing day.")

```

This makes it clear that decreasing the delay between test and isolation is more important than increasing frequency. In addition, systematic testing is superior to random testing when infections are only acquired from the community, with systematic testing always resulting in fewer expected cases than random testing. Some systematic testing scenarios even perform similarly to random testing scenarios with higher frequency (e.g. compare S5 to S7). Systematic testing on the first day of the work week with instant turnaround (e.g. antigen testing) also results in the most cases avoided per test conducted.

### Adding workplace transmission  
```{r run_sims_R_work05_lambda1, echo = FALSE, cache = TRUE}
# No testing  
no_test_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda    = lambda1*dt,
                        R_work     = 0.5,
                        R         = 1,
                        delay     = 0,
                        test_sens = 0,
                        workers   = workers,
                        sim_t     = sim_t,
                        dt        = dt,
                        verbose   = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S1",
           R_work = 0.5,
           delay = 0,
           testday = "None",
           lambda = lambda1, 
           testfreq = 0)
}))

# Random pcr testing once every other week
test_r1_biweek_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S12",
           R_work = 0.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# Random antigen testing once every other week
test_r1_biweek_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S13",
           R_work = 0.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))


# Random pcr testing once per week
test_r1_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S2",
           R_work = 0.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# Random antigen testing once per week
test_r1_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S3",
           R_work = 0.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# pcr testing on the first workday of every other week
test_day1_biweek_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S14",
           R_work = 0.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 0.5)
}))

# antigen testing on the first workday of every other week
test_day1_biweek_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S15",
           R_work = 0.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 0.5)
}))


# pcr testing on first day of work week
test_day1_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S4",
           R_work = 0.5,
           delay = 2,
           testday = "1",
           lambda = lambda1, 
           testfreq = 1)
}))


# antigen testing on first day of work week
test_day1_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S5",
           R_work = 0.5,
           delay = 0,
           testday = "1",
           lambda = lambda1, 
           testfreq = 1)
}))


# Random pcr testing twice per week
test_r2_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S6",
           R_work = 0.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 2)
}))


# Random antigen testing twice per week
test_r2_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S7",
           R_work = 0.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 2)
}))


# pcr testing on first and third day of work week
test_day13_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S8",
           R_work = 0.5,
           delay = 2,
           testday = "13",
           lambda = lambda1, 
           testfreq = 2)
}))


# antigen testing on first and third day of work week
test_day13_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S9",
           R_work = 0.5,
           delay = 0,
           testday = "13",
           lambda = lambda1, 
           testfreq = 2)
}))

# pcr testing on all but last day of work week
test_day1234_pcr_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S10",
           R_work = 0.5,
           delay = 2,
           testday = "1234",
           lambda = lambda1, 
           testfreq = 4)
}))


# antigen testing on all but last day
test_day1234_ant_sims_l1_a05 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 0.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S11",
           R_work = 0.5,
           delay = 0,
           testday = "1234",
           lambda = lambda1, 
           testfreq = 4)
}))
```

```{r run_sims_R_work15_lambda1, echo = FALSE, cache = TRUE}
# No testing  
no_test_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda    = lambda1*dt,
                        R_work     = 1.5,
                        R         = 1,
                        delay     = 0,
                        test_sens = 0,
                        workers   = workers,
                        sim_t     = sim_t,
                        dt        = dt,
                        verbose   = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S1",
           R_work = 1.5,
           delay = 0,
           testday = "None",
           lambda = lambda1, 
           testfreq = 0)
}))

# Random pcr testing once every other week
test_r1_biweek_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S12",
           R_work = 1.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# Random antigen testing once every other week
test_r1_biweek_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S13",
           R_work = 1.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))


# Random pcr testing once per week
test_r1_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S2",
           R_work = 1.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# Random antigen testing once per week
test_r1_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S3",
           R_work = 1.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 1)
}))

# pcr testing on the first workday of every other week
test_day1_biweek_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S14",
           R_work = 1.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 0.5)
}))

# antigen testing on the first workday of every other week
test_day1_biweek_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1_biweekly,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S15",
           R_work = 1.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 0.5)
}))


# pcr testing on first day of work week
test_day1_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S4",
           R_work = 1.5,
           delay = 2,
           testday = "1",
           lambda = lambda1, 
           testfreq = 1)
}))


# antigen testing on first day of work week
test_day1_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S5",
           R_work = 1.5,
           delay = 0,
           testday = "1",
           lambda = lambda1, 
           testfreq = 1)
}))


# Random pcr testing twice per week
test_r2_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S6",
           R_work = 1.5,
           delay = 2,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 2)
}))


# Random antigen testing twice per week
test_r2_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S7",
           R_work = 1.5,
           delay = 0,
           testday = "rand",
           lambda = lambda1, 
           testfreq = 2)
}))


# pcr testing on first and third day of work week
test_day13_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S8",
           R_work = 1.5,
           delay = 2,
           testday = "13",
           lambda = lambda1, 
           testfreq = 2)
}))


# antigen testing on first and third day of work week
test_day13_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S9",
           R_work = 1.5,
           delay = 0,
           testday = "13",
           lambda = lambda1, 
           testfreq = 2)
}))

# pcr testing on all but last day of work week
test_day1234_pcr_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S10",
           R_work = 1.5,
           delay = 2,
           testday = "1234",
           lambda = lambda1, 
           testfreq = 4)
}))


# antigen testing on all but last day
test_day1234_ant_sims_l1_a15 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = lambda1*dt,
                        R_work   = 1.5,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S11",
           R_work = 1.5,
           delay = 0,
           testday = "1234",
           lambda = lambda1, 
           testfreq = 4)
}))
```

```{r sum_sims_work, echo = FALSE, message = FALSE}
#qwraps2::lazyload_cache_dir("Analysis/Methods_Results_cache/docx/")

# Data frame summarizing each simulation's status at the end: tests, expected cases, and infectious days 
work_sims_end <- bind_rows(
  no_test_sims_l1_a0,
  test_r1_biweek_pcr_sims_l1_a0,
  test_r1_biweek_ant_sims_l1_a0,
  test_r1_pcr_sims_l1_a0,
  test_r1_ant_sims_l1_a0,
  test_day1_biweek_pcr_sims_l1_a0,
  test_day1_biweek_ant_sims_l1_a0,
  test_day1_pcr_sims_l1_a0,
  test_day1_ant_sims_l1_a0,
  test_r2_pcr_sims_l1_a0,
  test_r2_ant_sims_l1_a0,
  test_day13_pcr_sims_l1_a0,
  test_day13_ant_sims_l1_a0,
  test_day1234_pcr_sims_l1_a0,
  test_day1234_ant_sims_l1_a0,
  no_test_sims_l1_a05,
  test_r1_biweek_pcr_sims_l1_a05,
  test_r1_biweek_ant_sims_l1_a05,
  test_r1_pcr_sims_l1_a05,
  test_r1_ant_sims_l1_a05,
  test_day1_biweek_pcr_sims_l1_a05,
  test_day1_biweek_ant_sims_l1_a05,
  test_day1_pcr_sims_l1_a05,
  test_day1_ant_sims_l1_a05,
  test_r2_pcr_sims_l1_a05,
  test_r2_ant_sims_l1_a05,
  test_day13_pcr_sims_l1_a05,
  test_day13_ant_sims_l1_a05,
  test_day1234_pcr_sims_l1_a05,
  test_day1234_ant_sims_l1_a05,
  no_test_sims_l1_a15,
  test_r1_biweek_pcr_sims_l1_a15,
  test_r1_biweek_ant_sims_l1_a15,
  test_r1_pcr_sims_l1_a15,
  test_r1_ant_sims_l1_a15,
  test_day1_biweek_pcr_sims_l1_a15,
  test_day1_biweek_ant_sims_l1_a15,
  test_day1_pcr_sims_l1_a15,
  test_day1_ant_sims_l1_a15,
  test_r2_pcr_sims_l1_a15,
  test_r2_ant_sims_l1_a15,
  test_day13_pcr_sims_l1_a15,
  test_day13_ant_sims_l1_a15,
  test_day1234_pcr_sims_l1_a15,
  test_day1234_ant_sims_l1_a15,
) %>% 
  group_by(sim, scenario, delay, R_work, testday, lambda, testfreq) %>% 
  summarise(totcases = sum(exp_cases),
            totdays  = sum(inf_days),
            tottests = sum(tests_adm)) %>% 
  ungroup()

# Summarise across all simulations for each parameter set
sims_sum <- sims_end %>% 
  group_by(scenario, delay, R_work, testday, lambda, testfreq) %>% 
  summarise(across(.cols = c("totcases", "totdays", "tottests"),
                   .fns  = list("median", "q_025", "q_25", "q_75", "q_975"))) %>% 
  ungroup()

# get expected cases in no-testing scenario for each transmission intensity
a0l1_exp_cases_base <- sims_sum %>% 
  filter(testday == "None" & lambda == lambda1) %>% 
  pull(totcases_1)

a0l2_exp_cases_base <- sims_sum %>% 
  filter(testday == "None" & lambda == lambda2) %>% 
  pull(totcases_1)

a0l3_exp_cases_base <- sims_sum %>% 
  filter(testday == "None" & lambda == lambda3) %>% 
  pull(totcases_1)

# Add cases avoided in reference to no-testing scenario
sims_sum2 <- sims_end %>% 
  mutate(avoidedpertest = case_when(lambda == lambda1 ~ round((a0l1_exp_cases_base-totcases) / tottests * 1000, 2),
                                    lambda == lambda2 ~ round((a0l2_exp_cases_base-totcases) / tottests * 1000, 2),
                                    lambda == lambda3 ~ round((a0l3_exp_cases_base-totcases) / tottests * 1000, 2)),
         tests1000s = tottests/1000) %>% 
  group_by(delay, testday,testfreq,lambda, scenario) %>% 
  summarise(across(.cols = c("totcases", "tests1000s", "avoidedpertest"),
                   .fns  = list("median", "q_25", "q_75"))) %>% 
  ungroup() %>% 
  mutate(`TestScenario` = case_when(scenario == "S1" ~ "None",
                                    scenario == "S2" ~ "Rand1pw PCR",
                                    scenario == "S3" ~ "Random weekly",
                                    scenario == "S4" ~ "Syst1pw PCR",
                                    scenario == "S5" ~ "Systematic weekly",
                                    scenario == "S6" ~ "Rand2pw PCR",
                                    scenario == "S7" ~ "Random 2/week",
                                    scenario == "S8" ~ "Syst2pw PCR",
                                    scenario == "S9" ~ "Systematic 2/week",
                                    scenario == "S10" ~ "Syst4pw PCR",
                                    scenario == "S11" ~ "Systematic 4/week",
                                    scenario == "S12" ~ "Rand05pw PCR",
                                    scenario == "S13" ~ "Random biweekly",
                                    scenario == "S14" ~ "Syst05pw PCR",
                                    scenario == "S15" ~ "Systematic biweekly"))

sims_cases_sum <- sims_sum2 %>% 
  mutate("Expected Cases" = paste0(round(totcases_1), " (", 
                                   round(totcases_2), " - ",
                                   round(totcases_3), ")")) %>% 
  dplyr::select(scenario, lambda, delay, testday, testfreq, totcases_1, `Expected Cases`)

sims_tests_sum <- sims_sum2 %>% 
  mutate("Tests Conducted (1000s)" = paste0(round(tests1000s_1/1000), " (", 
                                            round(tests1000s_2/1000), " - ",
                                            round(tests1000s_3/1000), ")")) %>% 
  dplyr::select(scenario, lambda, tests1000s_1, `Tests Conducted (1000s)`)

sims_avoided_sum <- sims_sum2 %>% 
  mutate("Avoided/1000 tests" = paste0(round(avoidedpertest_1,2), " (", 
                                       round(avoidedpertest_2,2), " - ",
                                       round(avoidedpertest_3,2), ")")) %>% 
  dplyr::select(scenario, lambda, avoidedpertest_1, `Avoided/1000 tests`)


sims_all_sum <- sims_cases_sum %>% 
  left_join(sims_tests_sum, by = c("scenario", "lambda")) %>% 
  left_join(sims_avoided_sum, by = c("scenario", "lambda"))

```

```{r sims_sum_fig_work, include = TRUE}
sims_sum2 %>% 
  filter(delay == 0) %>% 
  mutate(avoidedpertest_2 = if_else(is.infinite(avoidedpertest_2), NA_real_, avoidedpertest_2),
         avoidedpertest_3 = if_else(is.infinite(avoidedpertest_3), NA_real_, avoidedpertest_3)) %>% 
  pivot_longer(cols = totcases_1:avoidedpertest_3,
               names_sep = "_",
               names_to = c("measure", ".value")) %>% 
  rename("Med" = `1`,
         "q25" = `2`,
         "q75" = `3`) %>% 
  mutate(measure = factor(case_when(measure == "avoidedpertest" ~ "Cases avoided/test",
                                    measure == "tests1000s" ~ "Tests (1000s)",
                                    measure == "totcases" ~ "Cases"), 
         levels = c("Cases", "Tests (1000s)", "Cases avoided/test"))) %>% 
  ggplot(aes(x = as.factor(lambda),
             y = Med,
             ymin = q25,
             ymax = q75,
             fill = TestScenario)) +
    geom_col(position = position_dodge()) +
    geom_errorbar(position =position_dodge(width = 0.9)) +
    facet_wrap(.~measure, scales = "free_y") +
    scale_fill_manual(values = c("#ca5642", "#c65c8a", "#d09744", "#b05cc6",
                                 "#70b249", "#6e7ecb", "#81833a", "#4bae92")) +
    theme_classic() +
    theme(strip.background = element_blank(),
          strip.text = element_text(face = "bold", size = 12)) +
    labs(x = "Community Prevalence", y = "Value")

ggsave(here::here("Plots/sim_results_work.png"),
       width = 7.5, height = 4, units = "in")
```


### Adding workplace transmission and leaky cohorts caused by 1 irregular shift per week  

### PCR test turnaround time and antigen test sensitivity  
```{r tat_sens_grid, cache = T}
tat_sens_grid <- expand.grid(delay = c(0,c(1:3)/dt-1),
                             test_sens = c(0, 0.025, 0.05, 0.1))

tat_sens_grid <- as.data.frame(tat_sens_grid) %>% 
  slice(rep(1:n(), each = n_sims))

test_day1_tat_sens_comp <- apply(tat_sens_grid, 1, function(x){
  cases_tests <- sim_work_transmission(Lambda = lambda2*dt,
                                       R_work   = 0,
                                       R       = 1,
                                       delay   = x[1],
                                       test_sens = x[2],
                                       workers = workers_testday1,
                                       sim_t   = sim_t,
                                       dt      = dt,
                                       verbose = F)$cases_tests
  
  return(c("tot_cases" = sum(cases_tests$exp_cases),
           "tot_tests" = sum(cases_tests$tests_adm)))
})

tat_sens_res <- cbind(tat_sens_grid, t(test_day1_tat_sens_comp)) %>% 
  group_by(delay, test_sens) %>% 
  summarise(across(.cols = c("tot_cases", "tot_tests"),
                   .fns  = list("median", "q_025", "q_25", "q_75", "q_975"))) %>% 
  ungroup()

```

```{r tat_sens_grid_plot, include = TRUE}
tat_sens_res %>% 
  ggplot(aes(x = as.factor(test_sens), y = as.factor(delay), fill = tot_cases_1)) +
    geom_tile() +
    theme_bw() +
    scale_y_continuous(labels = c("0", "1", "2", "3")) +
    scale_fill_viridis_b() +
    labs(x = "Test Detection limit",
         y = "Test Delay",
         fill = "Expected\nCases")

```

