---
title: "Additional analyses"
author: "Chris Hoover et al"
date: "4/20/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)

library(tidyverse)
source(here::here("R/Utils.R"))
source(here::here("R/Sim_Functions.R"))
```

## Individual-based simulation framework  
* All staff are assigned a work schedule that determines time frames when they are working. $\mathbf{I}(w_{it})$ is an indicator function for whether staff member $i$ is working at the facility on day $t$.  
* In addition to their work schedule, all staff are assigned a testing schedule, encoded by function $\mathbf{T}(w_{it})$.  
* All staff are subject to two sources of infection: community and workplace, represented by force of infection parameters $\lambda_c$ and $\lambda_w$, respectively. In addition, we introduce a partitioning parameter, $\alpha$, representing the relative probability of acquiring infection in the workplace versus in the community, therefore $\lambda_w=\lambda_c\alpha$ and $\Lambda_{it}=\lambda_c\alpha\mathbf{I}(w_{it})+\lambda_c(1-\mathbf{I}(w_{it}))$. New cases at each time step are then generated by subjecting all susceptible staff to a Bernoulli trial where $p=\Lambda_{it}$  
* Whenever a new staff infection is generated, parameters for the individual are drawn to determine the latent period ($t_{latent}$), the incubation period ($t_{incubation}$), and the total infectious period ($t_{infectious}$) to generate an infectiousness profile ($\beta_{it}$). Assuming constant $\mathcal{R}$ across all individuals, the expected number of workplace cases produced on day $t$ by individual $i$ is $r_{it}=\mathcal{R}\beta_{it}\mathbf{I}(w_{it})$  
* Main outcome is expected number of cases transmitted by staff over the simulation timeframe: $\mathbf{E}[cases]=\sum_{t=1}^{t_{sim}}\sum_{i=1}^n\mathbf{I}(w_{it})r_{it}$   
* Isolated staff are not retested, but recovered staff are tested as normal  

## Individual based model simulations  
### Goal 1: Determine impact of different testing interventions on expected number of imported cases  
Basically interested in three variables: pcr vs antigen testing (which basically comes down to turnaround time if we assume antigen tests are equal to pcr in their ability to detect active infection), random vs systematic day of testing, and frequency of testing. We propose the following scenarios encompassing combinations of these variables to explore:

* **S1)** No testing  
* **S2)** Random PCR testing once per work week with test report on second day following test  
* **S3)** Random antigen testing once per work week with immediate test report  
* **S4)** PCR testing on first day of work week with test report on second day following test  
* **S5)** Antigen testing on first day of work week with immediate test report  
* **S6)** Random PCR testing twice per work week with test report on second day following test  
* **S7)** Random antigen testing twice per work week with immediate test report  
* **S8)** PCR testing on first and third day of work week with test report on second day following test  
* **S9)** Antigen testing on first and third day of work week with immediate test report  
* **S10)** PCR testing on all days of work week with test report on second day following test  
* **S11)** Antigen testing on all days of work week with immediate test report  

```{r sim_setup, echo = FALSE}
# Sim inputs
  n_sims      <- 100
  lambda      <- 0.005
  days        <- 180
  dt          <- 8/24
  sim_t       <- days*(1/dt)
  n_staff     <- 700
  staff_state <- rep("S", n_staff)

# Generate master schedule
  work_weeks         <- ceiling(days/7)
  schedule_shifts    <- rep(c("M", "E", "N"), times = days)
  schedule_days      <- rep(rep(c("U", "M", "T", "W", "R", "F", "S"), each = 1/dt), 
                         times = work_weeks)[1:length(schedule_shifts)]
  schedule_work_week <- rep(1:work_weeks, each = 7/dt)[1:length(schedule_shifts)]
  master_schedule    <- paste(schedule_days, schedule_shifts, schedule_work_week, sep = "_")

```

```{r base_workers, echo = FALSE}
set.seed(430)
# Generate list of workers with no testing for model simulation
workers <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"
  
  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule  
  test_schedule <- rep(0, sim_t)
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})
```

```{r workers_testdays, echo = FALSE}
set.seed(430)
# Generate list of workers with testing on first day of shift for model simulation
workers_testday1 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"

  
  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  test_schedule <- if_else(substr(work_days,1,1) == schedule_days & work_shift == schedule_shifts,
                           1, 0 )
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

workers_testday2 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"

  
  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  test_schedule <- if_else(substr(work_days,2,2) == schedule_days & work_shift == schedule_shifts,
                           1, 0 )
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

workers_testday3 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"

  
  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  test_schedule <- if_else(substr(work_days,3,3) == schedule_days & work_shift == schedule_shifts,
                           1, 0 )
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

workers_testday4 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"


  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  test_schedule <- if_else(substr(work_days,4,4) == schedule_days & work_shift == schedule_shifts,
                           1, 0 )
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

workers_testday13 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"


  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  test_schedule <- if_else(substr(work_days,1,1) == schedule_days & work_shift == schedule_shifts, 1, 
                           if_else(substr(work_days,3,3) == schedule_days & work_shift == schedule_shifts, 1, 0))
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

workers_testday24 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"


  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
    
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  test_schedule <- if_else(substr(work_days,2,2) == schedule_days & work_shift == schedule_shifts, 1, 
                           if_else(substr(work_days,4,4) == schedule_days & work_shift == schedule_shifts, 1, 0))
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

workers_testday1234 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"


  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
    
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on same days as work schedule
  test_schedule <- schedule_fin
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

# Random work days
# Single random day during the work week
workers_testday_r1 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"


  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
    
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaul probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  work_days_string <- sapply(1:nchar(work_days), function(x){substr(work_days,x,x)})
  
  test_days <- sample(work_days_string, work_weeks, replace = T)
  test_days_schedule <- paste(test_days, work_shift, c(1:work_weeks), sep = "_")
  
  test_schedule <- if_else(master_schedule %in% test_days_schedule, 1, 0)
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay          <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

# Two random days during the work week
workers_testday_r2 <- lapply(1:n_staff, function(s){
  # Worker state and infectious profile parameters for if/when they become infected  
  state <- character(sim_t+1)
  state[1] <- "S"


  inf_pars <- sim_inf_pars(1)
  t_inc <- inf_pars[1]
  t_lnt <- inf_pars[2]
  t_inf <- inf_pars[3]
  
  # Worker schedule  
  # Randomly determine if worker works morning, night or day shift with equal probability  
  draw_shift <- runif(1,0,1)
  work_shift <- if_else(draw_shift < 1/3, "M",
                        if_else(draw_shift > 2/3, "N", "E"))
  
  # Randomly determine weekly schedule from four options: 1)Sat-Tues, 2)Tues-Sat,3)Thurs-Sun, 4)Mon-Thurs with eaual probability
  draw_days <- runif(1,0,1)
  work_days <- if_else(draw_days < 1/4, "SUMT",
                       if_else(draw_days > 3/4, "MTWR", 
                               if_else(draw_days > 1/4 & draw_days < 2/4, "TWRF", "RFSU")))
  
  # Binary work schedule
  shift10 <- if_else(work_shift == schedule_shifts, 1, 0)
  work10  <- if_else(schedule_days %in% unlist(strsplit(work_days, "")), 1, 0)
  
  schedule_fin <- if_else(shift10 + work10 == 2, 1, 0)
  
  # Binary test schedule with test occurring on day 1 of work shift
  work_days_string <- sapply(1:nchar(work_days), function(x){substr(work_days,x,x)})
  
  test_days <- unlist(lapply(1:work_weeks, function(x){sample(work_days_string, 2, replace = F)}))
  test_days_schedule <- paste(test_days, work_shift, rep(c(1:work_weeks), each = 2), sep = "_")
  
  test_schedule <- if_else(master_schedule %in% test_days_schedule, 1, 0)
  
  # Return worker characteristics in list  
  worker                <- list()
  worker$state          <- state
  worker$t_latent       <- t_lnt
  worker$t_incubation   <- t_inc
  worker$t_infectious   <- t_inf
  worker$infectiousness <- numeric()
  worker$t_infect       <- -Inf
  worker$delay         <- 0
  worker$work_schedule  <- schedule_fin
  worker$test_schedule  <- test_schedule
  
  return(worker)
  
})

```

## No workplace transmission ($\alpha=0$) scenarios  
  
```{r test_runs, echo=FALSE, eval = FALSE}
no_tests <- sim_work_transmission(Lambda    = 0.01*dt,
                                  alpha     = 0,
                                  R         = 1,
                                  delay     = 0,
                                  test_sens = 0,
                                  workers   = workers,
                                  sim_t     = sim_t,
                                  dt        = dt,
                                  verbose   = F)

all_tests <-   sim_work_transmission(Lambda = 0.01*dt,
                                     alpha   = 0,
                                     R       = 1,
                                     delay   = 0,
                                     test_sens = 0,
                                     workers = workers_testday1234,
                                     sim_t   = sim_t,
                                     dt      = dt,
                                     verbose = F)

table(unlist(lapply(all_tests$workers, function(w) w$state[sim_t])))
```


```{r run_sims_alpha0, echo = FALSE, cache = TRUE}
# No testing  
no_test_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda    = 0.01*dt,
                        alpha     = 0,
                        R         = 1,
                        delay     = 0,
                        test_sens = 0,
                        workers   = workers,
                        sim_t     = sim_t,
                        dt        = dt,
                        verbose   = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S1",
           alpha = 0,
           delay = 0,
           testday = "None",
           testfreq = 0)
}))

# Random pcr testing once per week
test_r1_pcr_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S2",
           alpha = 0,
           delay = 2,
           testday = "rand",
           testfreq = 1)
}))


# Random antigen testing once per week
test_r1_ant_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S3",
           alpha = 0,
           delay = 0,
           testday = "rand",
           testfreq = 1)
}))

# pcr testing on first day of work week
test_day1_pcr_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S4",
           alpha = 0,
           delay = 2,
           testday = "1",
           testfreq = 1)
}))


# antigen testing on first day of work week
test_day1_ant_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S5",
           alpha = 0,
           delay = 0,
           testday = "1",
           testfreq = 1)
}))


# Random pcr testing twice per week
test_r2_pcr_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S6",
           alpha = 0,
           delay = 2,
           testday = "rand",
           testfreq = 2)
}))


# Random antigen testing twice per week
test_r2_ant_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday_r2,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S7",
           alpha = 0,
           delay = 0,
           testday = "rand",
           testfreq = 2)
}))


# pcr testing on first and third day of work week
test_day13_pcr_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S8",
           alpha = 0,
           delay = 2,
           testday = "13",
           testfreq = 2)
}))


# antigen testing on first and third day of work week
test_day13_ant_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday13,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S9",
           alpha = 0,
           delay = 0,
           testday = "13",
           testfreq = 2)
}))

# pcr testing on first and third day of work week
test_day1234_pcr_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 2/dt-1,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S10",
           alpha = 0,
           delay = 2,
           testday = "1234",
           testfreq = 4)
}))


# antigen testing on first and third day of work week
test_day1234_ant_sims_a0 <- bind_rows(lapply(1:n_sims, function(x){
  sim_work_transmission(Lambda = 0.01*dt,
                        alpha   = 0,
                        R       = 1,
                        delay   = 0,
                        test_sens = 0,
                        workers = workers_testday1234,
                        sim_t   = sim_t,
                        dt      = dt,
                        verbose = F)$cases_tests %>% 
    mutate(sim = x,
           scenario = "S11",
           alpha = 0,
           delay = 0,
           testday = "1234",
           testfreq = 4)
}))
```

```{r sum_sims, include=TRUE, echo = FALSE, message = FALSE}
sims_sum <- bind_rows(
  no_test_sims_a0,
  test_r1_pcr_sims_a0,
  test_r1_ant_sims_a0,
  test_day1_pcr_sims_a0,
  test_day1_ant_sims_a0,
  test_r2_pcr_sims_a0,
  test_r2_ant_sims_a0,
  test_day13_pcr_sims_a0,
  test_day13_ant_sims_a0,
  test_day1234_pcr_sims_a0,
  test_day1234_ant_sims_a0
) %>% 
  group_by(sim, delay, testday, testfreq) %>% 
  summarise(tot_cases = sum(exp_cases),
            tot_tests = sum(tests_adm),
            scenario = first(scenario)) %>% 
  ungroup() %>% 
  group_by(delay, testday,testfreq, scenario) %>% 
  summarise(across(.cols = c("tot_cases", "tot_tests"),
                   .fns  = list("median", "q_025", "q_25", "q_75", "q_975"))) %>% 
  ungroup()


sims_cases_sum <- sims_sum %>% 
  mutate("Expected Cases" = paste0(round(tot_cases_1), " (", 
                                   round(tot_cases_3), " - ",
                                   round(tot_cases_5), ")")) %>% 
  dplyr::select(scenario, delay, testday, testfreq, tot_cases_1, `Expected Cases`)

sims_cases_sum %>% 
  arrange(-tot_cases_1) %>% 
  dplyr::select(-tot_cases_1) %>% 
  knitr::kable(caption = "Expected cases imported into facility across different testing scenarios indicated by test frequency, $f$, test delay, $d$, and systematic vs random testing day.")

```

## Sensitivity analyses  
* Incorporate self isolation at symptom onset and proportion of symptomatic cases that adhere to self-isolation, proportion of cases symptomatic  
  - whether the case will be asymptomatic or symptomatic ($p_{symp}$) drawn as parameter in addition to infectiousness parameters  
* Antigen test sensitivity  
* PCR turnaround time  
